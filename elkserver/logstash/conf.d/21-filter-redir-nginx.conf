# Nginx Redirector Log Parser
# Parses Nginx access logs with RedELK custom format

filter {
  if [fields][infralogtype] == "redirtraffic" and [fields][redirprogram] == "nginx" {

    grok {
      match => { "message" => "%{IPORHOST:source.ip} - %{USER:user.name} \[%{HTTPDATE:timestamp}\] \"(?:%{WORD:http.request.method} %{NOTSPACE:url.original}(?: HTTP/%{NUMBER:http.version})?|%{DATA:nginx.rawrequest})\" %{NUMBER:http.response.status_code} %{NUMBER:http.response.body.bytes} \"%{DATA:http.request.referrer}\" \"%{DATA:user_agent.original}\" \"%{DATA:http.request.headers.x-forwarded-for}\" rt=%{NUMBER:nginx.request_time} uct=\"%{DATA:nginx.upstream_connect_time}\" uht=\"%{DATA:nginx.upstream_header_time}\" urt=\"%{DATA:nginx.upstream_response_time}\" \"%{DATA:redir.frontend.name}\" \"%{DATA:redir.backend.name}\"" }
    }

    date {
      match => [ "timestamp", "dd/MMM/yyyy:HH:mm:ss Z" ]
      target => "@timestamp"
    }

    # Parse X-Forwarded-For
    if [http.request.headers.x-forwarded-for] and [http.request.headers.x-forwarded-for] != "-" {
      mutate {
        split => { "http.request.headers.x-forwarded-for" => "," }
      }
      mutate {
        replace => { "source.ip" => "%{[http.request.headers.x-forwarded-for][0]}" }
      }
    }

    # GeoIP enrichment
    geoip {
      source => "source.ip"
      target => "source.geo"
    }

    # User agent parsing
    useragent {
      source => "user_agent.original"
      target => "user_agent"
    }

    # Convert numeric fields
    mutate {
      add_field => {
        "infra.log_type" => "redirtraffic"
        "infra.log_subtype" => "nginx"
        "event.module" => "redelk"
        "event.dataset" => "redirtraffic"
      }
      convert => {
        "http.response.status_code" => "integer"
        "http.response.body.bytes" => "integer"
        "nginx.request_time" => "float"
      }
    }

    # Performance monitoring
    if [nginx.request_time] > 5.0 {
      mutate { add_tag => [ "slow_request" ] }
    }

    # Flag suspicious patterns
    if [user_agent.original] =~ /(?i:curl|wget|python|powershell|nmap|nikto|sqlmap|dirbuster|burp|zap|acunetix)/ {
      mutate { add_tag => [ "suspicious_useragent" ] }
    }
  }
}
