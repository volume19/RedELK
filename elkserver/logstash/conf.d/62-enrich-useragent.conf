# User Agent Parsing and Enrichment
filter {
  if [user_agent][original] {
    useragent {
      source => "[user_agent][original]"
      target => "[user_agent]"
      ecs_compatibility => "v1"
    }

    # Detect common security scanners and bots
    if [user_agent][original] {
      # Security scanners
      if [user_agent][original] =~ /(?i)(nmap|nikto|sqlmap|burp|zap|acunetix|nessus|openvas|metasploit|nuclei|gobuster|dirb|wfuzz|hydra|medusa|masscan|shodan|censys|zgrab)/ {
        mutate {
          add_tag => [ "security_scanner" ]
          add_field => { "[threat][scanner]" => "true" }
        }
      }

      # Search engine bots
      if [user_agent][original] =~ /(?i)(googlebot|bingbot|slurp|duckduckbot|baiduspider|yandexbot|facebookexternalhit|twitterbot|linkedinbot|whatsapp|telegram)/ {
        mutate {
          add_tag => [ "search_bot" ]
          add_field => { "[bot][detected]" => "true" }
        }
      }

      # Programming libraries
      if [user_agent][original] =~ /(?i)(python-requests|urllib|wget|curl|powershell|invoke-webrequest|winhttp|go-http-client|java|ruby|perl|php)/ {
        mutate {
          add_tag => [ "automated_tool" ]
          add_field => { "[threat][automated]" => "true" }
        }
      }

      # Suspicious or empty user agents
      if [user_agent][original] == "-" or [user_agent][original] == "" or [user_agent][original] =~ /^Mozilla$/ {
        mutate {
          add_tag => [ "suspicious_ua" ]
          add_field => { "[threat][suspicious_ua]" => "true" }
        }
      }

      # Known C2 user agents
      if [user_agent][original] =~ /(?i)(Mozilla\/4\.0 \(compatible; MSIE 7\.0; Windows NT 5\.1; \.NET CLR 2\.0\.50727\)|Mozilla\/5\.0 \(compatible; MSIE 9\.0; Windows NT 6\.1; WOW64; Trident\/5\.0\))/ {
        mutate {
          add_tag => [ "known_c2_ua" ]
          add_field => { "[threat][c2_ua_match]" => "true" }
        }
      }
    }
  }
}